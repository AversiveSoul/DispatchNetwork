<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - Tactical Interface</title>
    <script>
        (function() {
            const isAuthenticated = sessionStorage.getItem('sdn_auth');
            if (isAuthenticated !== 'true') {
                window.location.href = "index.html";
            }
        })();
    </script>
     <script>
    (function() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                         || (window.innerWidth <= 800);

        if (isMobile) {
            window.location.href = "no-mobile.html";
        }
    })();
</script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; display: flex;
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }
        .auth-box {
            border: 1px solid #00ff41; padding: 40px; text-align: center;
            background: rgba(0, 20, 0, 0.9); box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }
        .auth-btn {
            margin-top: 20px; padding: 10px 20px; border: 1px solid #60a5fa;
            color: #60a5fa; cursor: pointer; text-transform: uppercase; font-size: 14px;
        }
        .auth-btn:hover { background: rgba(96, 165, 250, 0.1); box-shadow: 0 0 10px #60a5fa; }

        .scanline { width: 100%; height: 100px; z-index: 99; background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(0, 255, 65, 0.1) 50%, rgba(0, 0, 0, 0) 100%); opacity: 0.1; position: absolute; bottom: 100%; animation: scanline 10s linear infinite; pointer-events: none; }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }
        
        .crt::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none; }
        
        .map-container { position: relative; width: 100%; height: 100%; cursor: crosshair; background-image: url('Dispatch_map.png'); background-size: cover; background-position: center; border: 2px solid #004411; }
        .marker { position: absolute; transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.3); }
        .marker-core { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid currentColor; background: rgba(0,0,0,0.7); box-shadow: 0 0 15px currentColor; }
        .marker-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .pulse-ring { position: absolute; width: 100%; height: 100%; border: 2px solid currentColor; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        .nav-link { position: relative; padding: 8px 16px; font-size: 11px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; transition: all 0.2s; border: 1px solid transparent; }
        .nav-link.agents { color: #60a5fa; border-color: rgba(96, 165, 250, 0.3); }
        .nav-link.villains { color: #f87171; border-color: rgba(248, 113, 113, 0.3); }
        .nav-link:hover { background: rgba(255, 255, 255, 0.05); border-color: currentColor; box-shadow: 0 0 10px currentColor; }
        
        .glow-border { border: 1px solid #00ff41; box-shadow: 0 0 15px rgba(0, 255, 65, 0.15); }
        .terminal-bg { background: rgba(2, 8, 2, 0.95); }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #004411; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #00ff41; }
    </style>
</head>
<body class="crt">
    <audio id="bgMusic" loop>
        <source src="musica1.mp3" type="audio/mpeg">
    </audio>

    <div id="overlay">
        <div class="auth-box">
            <h2 style="color: #00ff41; font-size: 18px; letter-spacing: 2px;">SISTEMA SDN AGUARDANDO AUTENTICAÇÃO</h2>
            <button id="startBtn" class="auth-btn">HABILITAR INTERFACE DE ÁUDIO & VÍDEO</button>
        </div>
    </div>

    <div id="root"></div>
    <div class="scanline"></div>

    <script>
        const music = document.getElementById('bgMusic');
        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('startBtn');

        music.volume = 0.15;

        startBtn.addEventListener('click', () => {
            music.play().catch(e => console.log("Erro ao tocar música:", e));
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        });
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [missions, setMissions] = useState([]);
            const [agents, setAgents] = useState([]);
            const [selectedMission, setSelectedMission] = useState(null);
            const [status, setStatus] = useState("SISTEMA ONLINE");

            const nomeUsuarioLogado = sessionStorage.getItem('active_user');
            const usuarioAtivo = agents.find(u => (u.heroName || u.Name || u.codinome) === nomeUsuarioLogado);

            const syncDatabase = async () => {
                const timestamp = new Date().getTime();
                try {
                    const [resA, resM] = await Promise.all([
                        fetch(`./agentes.json?v=${timestamp}`),
                        fetch(`./missions.json?v=${timestamp}`)
                    ]);
                    
                    if (!resA.ok || !resM.ok) throw new Error("Erro no carregamento");

                    const dataA = await resA.json();
                    const dataM = await resM.json();

                    setAgents(Array.isArray(dataA) ? dataA : [dataA]);
                    setMissions(Array.isArray(dataM) ? dataM : [dataM]);
                    setStatus("SISTEMA ONLINE");
                } catch (err) { 
                    console.error(err);
                    setStatus("ERRO DE SINCRONIA"); 
                }
            };

            useEffect(() => { syncDatabase(); }, []);

            return (
                <div className="h-screen w-screen flex flex-col p-4">
                    <header className="flex justify-between items-center mb-4 p-3 glow-border terminal-bg">
                        <div className="flex items-center gap-6">
                            <div>
                                <h1 className="text-xl font-light tracking-[0.3em] text-green-500">
                                    SDN//<span className="font-black tracking-normal">NETWORK</span>
                                </h1>
                                <div className="text-[9px] text-green-800 tracking-widest uppercase">Protocol: Encrypted_Access</div>
                            </div>

                            <nav className="flex gap-3 border-l border-green-900 pl-6">
                                <a href="SDNAgentNetwork.html" className="nav-link agents">Registro de Agentes</a>
                                <a href="vilains.html" className="nav-link villains">Registro de Vilões</a>
                                <a href="funcionarios.html" className="nav-link agents">Registro de Funcionários</a>
                                <a href="news.html" className="nav-link agents">Registro de Notícias</a>
                                <a href="feed.html" className="nav-link agents">Terminal de Comunicação</a>
                            </nav>
                        </div>
                        
                        <div className="flex gap-8 text-right items-center">
                            <div>
                                <div className="text-[10px] text-green-500 flex items-center justify-end gap-1.5 font-bold">
                                    <span className="relative flex h-1.5 w-1.5">
                                        <span className="animate-ping absolute h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                                    </span>
                                    {status}
                                </div>
                                <div className="text-xs font-black uppercase">{missions.length} Missões Ativas</div>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 relative glow-border overflow-hidden bg-black">
                        <div className="map-container">
                            {missions.map((m) => {
                                const isHigh = m.threatLevel?.toLowerCase().includes('alta') || 
                                               m.threatLevel?.toLowerCase().includes('crítico');
                                const colorClass = isHigh ? 'text-red-500' : 'text-green-500';

                                return (
                                    <div 
                                        key={m.id} 
                                        className={`marker ${colorClass}`} 
                                        style={{ left: `${m.x}%`, top: `${m.y}%` }}
                                        onClick={() => setSelectedMission(m)}
                                    >
                                        <div className="pulse-ring"></div>
                                        <div className="marker-core">
                                            <div className="marker-dot"></div>
                                        </div>
                                        <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 whitespace-nowrap">
                                            <span className="bg-black/80 text-[10px] px-2 py-0.5 border border-current font-bold uppercase">
                                                {m.operationId}
                                            </span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* POPUP CENTRALIZADO ESTILO TELA DE MISSÃO */}
                        {selectedMission && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-6 animate-in fade-in duration-300">
                                <div className="max-w-4xl w-full glow-border terminal-bg p-8 border-t-2 border-t-white shadow-[0_0_50px_rgba(0,0,0,1)] relative animate-in zoom-in duration-300">
                                    
                                    {/* Header do Pop-up */}
                                    <div className="flex justify-between items-center border-b border-green-900 mb-6 pb-4">
                                        <div className="flex items-center gap-4">
                                            <div className="h-8 w-1 bg-green-500"></div>
                                            <span className="text-2xl font-black text-white italic uppercase tracking-tighter">
                                                {selectedMission.operationId}
                                            </span>
                                        </div>
                                        <button 
                                            onClick={() => setSelectedMission(null)} 
                                            className="text-red-500 border border-red-900 px-4 py-1 text-xs hover:bg-red-500/10 hover:border-red-500 transition-all font-bold"
                                        >
                                            FECHAR [X]
                                        </button>
                                    </div>

                                    {/* Conteúdo em Grid para ocupar a tela */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                        
                                        {/* Coluna 1: Informações de Missão */}
                                        <div className="md:col-span-2 space-y-6">
                                            <div>
                                                <span className="text-green-800 block uppercase font-bold text-xs mb-1">[Nível de Ameaça]</span>
                                                <span className="text-white font-bold text-lg bg-red-900/20 px-3 py-1 border-l-2 border-red-500 inline-block">
                                                    {selectedMission.threatLevel}
                                                </span>
                                            </div>

                                            <div>
                                                <span className="text-green-800 block uppercase font-bold text-xs mb-1">[Objetivo Tático]</span>
                                                <p className="text-gray-300 text-sm leading-relaxed border border-green-900/30 p-4 bg-green-950/10">
                                                    {selectedMission.objective}
                                                </p>
                                            </div>
                                        </div>

                                        {/* Coluna 2: Perfil do Usuário */}
                                        <div className="flex flex-col items-center justify-center border-l border-green-900/30 pl-8">
                                            <div className="relative group">
                                                <div className="absolute -inset-1 bg-green-500 opacity-20 blur group-hover:opacity-40 transition"></div>
                                                <div className="w-40 h-48 border-2 border-green-500 p-1 bg-black relative">
                                                    <img 
                                                        src={usuarioAtivo ? `FotosDosAgentes/${usuarioAtivo.portraitFilename}` : 'https://via.placeholder.com/150?text=NA'} 
                                                        className="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500"
                                                        alt="User"
                                                    />
                                                </div>
                                            </div>
                                            
                                            <div className="mt-6 text-center">
                                                <p className="text-[12px] text-green-400 leading-tight">
                                                    Tem interesse nessa missão<br/>
                                                    <span className="text-white font-bold uppercase text-sm block mt-2">
                                                        {nomeUsuarioLogado}?
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Decorações Estéticas Inferiores */}
                                    <div className="mt-8 pt-4 border-t border-green-900/30 flex justify-between items-center opacity-40">
                                        <div className="text-[9px] uppercase tracking-widest">Acesso Restrito: Nível 4 // SDN_PROTOCOL</div>
                                        <div className="text-[9px] uppercase tracking-widest text-green-500">Coordinates: {selectedMission.x}, {selectedMission.y}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="mt-4 flex gap-3 overflow-x-auto pb-2 h-40 custom-scrollbar">
                        {agents.map((agent, i) => (
                            <div 
                                key={i} 
                                onClick={() => window.location.href = `SDNAgentNetwork.html?id=${agent.id || agent.FILE_ID || i}`}
                                className="min-w-[110px] glow-border terminal-bg p-2 flex flex-col items-center group hover:bg-green-950/20 transition-colors cursor-pointer"
                            >
                                <div className="w-full h-24 bg-black border border-green-900 overflow-hidden mb-2 group-hover:border-green-500">
                                    <img 
                                        src={`./FotosDosAgentes/${agent.portraitFilename}`} 
                                        className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-all group-hover:scale-105" 
                                        onError={(e) => { e.target.src='https://via.placeholder.com/100x120?text=USER'; }}
                                    />
                                </div>
                                <span className="text-[10px] font-bold truncate w-full text-center uppercase text-white mb-1.5">
                                    {agent.heroName || agent.Name || agent.codinome}
                                </span>
                                <div className="w-full bg-green-900/30 h-1 rounded-full">
                                    <div className="bg-green-500 h-full shadow-[0_0_5px_#00ff41]" style={{width: `${agent.repSdn || agent.PopularitySDN || 50}%`}}></div>
                                </div>
                            </div>
                        ))}
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>