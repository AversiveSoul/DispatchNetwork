<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
   <title>SDN - Terminal de Comunicação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon-green: #46fa5b; --bg-dark: #0a0e0d; }
        body { 
            background-color: var(--bg-dark); 
            color: var(--neon-green); 
            font-family: 'Share+Tech+Mono', monospace; 
        }
        .post-container { 
            border-left: 3px solid var(--neon-green); 
            background: rgba(70, 250, 91, 0.03);
            transition: all 0.3s;
        }
        .reply-card { 
            border-left: 1px solid rgba(70, 250, 91, 0.4); 
            margin-left: 4rem; 
            background: rgba(255, 255, 255, 0.02);
        }
        .nav-btn {
            border: 1px solid rgba(70, 250, 91, 0.3);
            padding: 8px 15px;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.3s;
            color: #70a1ff;
            background: rgba(0, 0, 0, 0.5);
            text-decoration: none;
        }
        .nav-btn:hover {
            background: var(--neon-green);
            color: black;
            box-shadow: 0 0 10px var(--neon-green);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e5655; border-radius: 10px; }
    </style>
</head>
<body class="p-6">
    <script>
        if (sessionStorage.getItem('sdn_auth') !== 'true') window.location.href = "index.html";
    </script>

    <div class="max-w-5xl mx-auto">
        <nav class="flex flex-wrap justify-center gap-4 mb-8 border-y border-green-900/50 py-4">
            <a href="SDNAgentNetwork.html" class="nav-btn">Registro de Agentes</a>
            <a href="vilains.html" class="nav-btn" style="color: #ff4757; border-color: rgba(255, 71, 87, 0.3);">Registro de Vilões</a>
            <a href="funcionarios.html" class="nav-btn">Registro de Funcionários</a>
            <a href="news.html" class="nav-btn">Registro de Notícias</a>
            <a href="missions.html" class="nav-btn">Terminal de Missões</a>
        </nav>

        <header class="mb-8 border-b border-green-900/50 pb-6 flex justify-between items-end">
            <div>
                <h1 class="text-4xl tracking-tighter uppercase font-bold text-white mb-2">Canal De Comunicação Dos Funcionários Internos</h1>
                <p class="text-sm opacity-60 italic">Comunicação Tática Segura</p>
            </div>
            <div class="text-right">
                <p class="text-xs uppercase opacity-60">Visualizando como:</p>
                <p id="current-user" class="text-xl text-green-400 font-bold">---</p>
            </div>
        </header>

        <div id="feed" class="flex flex-col gap-8 custom-scrollbar h-[70vh] overflow-y-auto pr-6">
            <p class="text-center animate-pulse text-xl">Acedendo aos ficheiros de log...</p>
        </div>
    </div>

    <script>
        document.getElementById('current-user').innerText = sessionStorage.getItem('active_user') || "AGENTE_DESCONHECIDO";

        async function initFeed() {
            try {
                const [resFunc, resComent] = await Promise.all([
                    fetch('./funcionarios.json'),
                    fetch('./comentarios.json')
                ]);

                const funcionarios = await resFunc.json();
                const comentarios = await resComent.json();
                const feed = document.getElementById('feed');
                feed.innerHTML = '';

                comentarios.forEach(coment => {
                    const autor = funcionarios.find(f => f.id === coment.id_funcionario);
                    
                    // Lógica da Data: Se não existir no JSON, fica vazio
                    const dataFormatada = coment.timestamp ? new Date(coment.timestamp).toLocaleString('pt-BR') : "";

                    const postDiv = document.createElement('div');
                    postDiv.className = "post-container p-6 rounded-r";

                    postDiv.innerHTML = `
                        <div class="flex gap-6 items-start mb-6">
                            <img src="./FotosDosFuncionarios/${autor?.portraitFilename || 'default.jpg'}" 
                                 class="w-20 h-20 border-2 border-green-500/30 object-cover shadow-lg shadow-green-900/20">
                            <div class="flex-1">
                                <div class="flex justify-between items-center border-b border-green-900/30 pb-2 mb-3">
                                    <p class="text-lg font-bold text-white uppercase tracking-wider">${autor?.Name || 'Desconhecido'}</p>
                                    <p class="text-xs opacity-50 font-mono">${dataFormatada}</p>
                                </div>
                                <p class="text-lg leading-relaxed text-green-100">${coment.texto}</p>
                            </div>
                        </div>
                        <div class="replies-area flex flex-col gap-4"></div>
                    `;

                    feed.appendChild(postDiv);
                    const repliesContainer = postDiv.querySelector('.replies-area');
                    
                    Object.keys(coment).forEach(key => {
                        if (key.startsWith('resposta')) {
                            const num = key.replace('resposta', '');
                            const idResp = coment[`id_funcionarioResposta${num}`];
                            const textoResp = coment[key];
                            const autorResp = funcionarios.find(f => f.id === idResp);

                            if (textoResp && idResp) {
                                const replyDiv = document.createElement('div');
                                replyDiv.className = "reply-card p-4 rounded";
                                replyDiv.innerHTML = `
                                    <div class="flex gap-4 items-center">
                                        <img src="./FotosDosFuncionarios/${autorResp?.portraitFilename || 'default.jpg'}" 
                                             class="w-10 h-10 border border-green-500/20 object-cover">
                                        <div>
                                            <p class="text-sm font-bold text-green-400">${autorResp?.Name || 'Anônimo'}:</p>
                                            <p class="text-base text-white/90 italic">"${textoResp}"</p>
                                        </div>
                                    </div>
                                `;
                                repliesContainer.appendChild(replyDiv);
                            }
                        }
                    });
                });
            } catch (err) {
                document.getElementById('feed').innerHTML = `<p class="text-red-500 text-center text-xl mt-10">FALHA NA SINCRONIZAÇÃO DOS DADOS.</p>`;
            }
        }
        initFeed();
    </script>
</body>
</html>